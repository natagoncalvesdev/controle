<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel ADM - Controle Financeiro</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --bg-main: #f0f2f5;
      --bg-section: #ffffff;
      --text-primary: #1d1d2e;
      --text-secondary: #6c7190;
      --border-color: #eef0fa;
      --accent-blue: #2563eb;
      --accent-2: #33c27f; /* Green for import */
      --accent-3: #ff6b6b; /* Red for logout */
    }

    body {
      font-family: "Segoe UI", sans-serif;
      background-color: var(--bg-main);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: var(--text-primary);
    }
    .admin-container {
      background: var(--bg-section);
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 500px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    h1 {
      margin-top: 0;
      color: var(--text-primary);
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-sizing: border-box;
      background: var(--bg-main);
      color: var(--text-primary);
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .btn-add {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .btn-add:hover {
      opacity: 0.9;
    }
    .btn-back {
      background-color: var(--text-secondary);
    }
    .btn-logout {
      background-color: var(--accent-3);
    }
    #error-message {
      color: #ba2f2f;
      margin-top: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <h1>Painel Administrativo</h1>
    <p id="user-info" style="color: var(--text-secondary);"></p>

    <div class="form-group">
      <label for="selectAnoAdmin">Selecione o Ano para Importar/Exportar</label>
      <select id="selectAnoAdmin"></select>
    </div>

    <div class="button-group">
      <button id="import-button" class="btn-add" style="background-color: var(--accent-2);" onclick="document.getElementById('file-input').click();">Importar Ano</button>
      <input type="file" id="file-input" accept=".json" style="display: none;" onchange="importarDados(event)">
      <button id="export-button" class="btn-add" style="background-color: var(--accent-blue);">Exportar Ano</button>
    </div>

    <div class="button-group">
      <button id="back-button" class="btn-add btn-back" onclick="window.location.href='index.html'">Voltar</button>
      <button id="logout-button" class="btn-add btn-logout">Sair</button>
    </div>

    <p id="error-message"></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVwUVoudM_IxWQgkLxlabinw4AXGgf1So",
      authDomain: "controle-f1437.firebaseapp.com",
      databaseURL: "https://controle-f1437-default-rtdb.firebaseio.com",
      projectId: "controle-f1437",
      storageBucket: "controle-f1437.firebasestorage.app",
      messagingSenderId: "796244202232",
      appId: "1:796244202232:web:4e98f9b9a3c34bd569e10d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const MESES = [
      "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];
    const ANO_BASE = 2025;
    const ANO_LIMITE = ANO_BASE + 10;

    let currentUser = null;
    let anoAtualAdmin = ""; // Vari√°vel para o ano selecionado no painel admin

    const selectAnoAdmin = document.getElementById("selectAnoAdmin");
    const exportButton = document.getElementById('export-button');
    const importButton = document.getElementById('import-button');
    const userInfoDisplay = document.getElementById('user-info');
    const errorMessage = document.getElementById('error-message');

    function popularListaAnosAdmin() {
      selectAnoAdmin.innerHTML = "";
      for (let ano = ANO_BASE; ano <= ANO_LIMITE; ano++) {
        const option = document.createElement("option");
        option.value = String(ano);
        option.textContent = String(ano);
        selectAnoAdmin.appendChild(option);
      }
      // Define o ano atual como padr√£o
      const hoje = new Date();
      let anoCorrente = hoje.getFullYear();
      if (anoCorrente < ANO_BASE || anoCorrente > ANO_LIMITE) {
        anoCorrente = ANO_BASE;
      }
      selectAnoAdmin.value = String(anoCorrente);
      anoAtualAdmin = String(anoCorrente);
    }

    async function garantirEstruturaUsuario(ano) {
      if (!currentUser || !/^[0-9]{4}$/.test(String(ano))) return;

      const anoRef = db.collection('users').doc(currentUser.uid).collection('anos').doc(String(ano));
      const anoDoc = await anoRef.get();

      if (!anoDoc.exists) {
        const batch = db.batch();
        batch.set(anoRef, { ano: Number(ano) });
        MESES.forEach(mesNome => {
          const mesRef = anoRef.collection('meses').doc(mesNome);
          batch.set(mesRef, { contas: [], adicionais: [], cartao: [], reservado: [], cartaoStatus: 'pendente' });
        });
        await batch.commit();
      }
    }

    async function exportarDados() {
      if (!anoAtualAdmin || !currentUser) {
        errorMessage.textContent = "Selecione um ano para exportar.";
        errorMessage.style.display = 'block';
        return;
      }

      exportButton.disabled = true;
      exportButton.textContent = 'Exportando...';
      errorMessage.style.display = 'none';

      try {
        const dadosCompletosDoAno = {
          ano: anoAtualAdmin,
          dadosMeses: {}
        };

        for (const mes of MESES) {
          const mesRef = db.collection('users').doc(currentUser.uid).collection('anos').doc(anoAtualAdmin).collection('meses').doc(mes);
          const doc = await mesRef.get();
          if (doc.exists) {
            dadosCompletosDoAno.dadosMeses[mes] = doc.data();
          }
        }

        const jsonString = JSON.stringify(dadosCompletosDoAno, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `dados_financeiros_${anoAtualAdmin}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(`Dados do ano ${anoAtualAdmin} exportados com sucesso!`);

      } catch (error) {
        console.error("Erro ao exportar dados:", error);
        errorMessage.textContent = "Ocorreu um erro ao exportar os dados. Tente novamente.";
        errorMessage.style.display = 'block';
      } finally {
        exportButton.disabled = false;
        exportButton.textContent = 'Exportar Ano';
      }
    }

    function importarDados(event) {
      const file = event.target.files[0];
      if (!file) return;

      importButton.disabled = true;
      importButton.textContent = 'Importando...';
      errorMessage.style.display = 'none';

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const dados = JSON.parse(e.target.result);

          // Valida√ß√£o b√°sica do arquivo
          if (!dados.ano || !dados.dadosMeses || typeof dados.dadosMeses !== 'object') {
            throw new Error("Formato de arquivo inv√°lido.");
          }

          if (!confirm(`Voc√™ tem certeza que deseja importar os dados para o ano ${dados.ano}? Todos os dados existentes para este ano ser√£o substitu√≠dos.`)) {
            return;
          }

          await garantirEstruturaUsuario(dados.ano);

          const batch = db.batch();
          for (const mes in dados.dadosMeses) {
            if (MESES.includes(mes)) {
              const mesRef = db.collection('users').doc(currentUser.uid).collection('anos').doc(dados.ano).collection('meses').doc(mes);
              batch.set(mesRef, dados.dadosMeses[mes]);
            }
          }

          await batch.commit();
          alert(`Dados do ano ${dados.ano} importados com sucesso!`);
          // N√£o recarrega a p√°gina, apenas informa o sucesso. O usu√°rio pode voltar para index.html.

        } catch (error) {
          console.error("Erro ao importar dados:", error);
          errorMessage.textContent = "Erro ao importar arquivo: " + error.message;
          errorMessage.style.display = 'block';
        } finally {
          event.target.value = null; // Limpa o input de arquivo
          importButton.disabled = false;
          importButton.textContent = 'Importar Ano';
        }
      };
      reader.readAsText(file);
    }

    // Event Listeners
    selectAnoAdmin.addEventListener("change", (e) => {
      anoAtualAdmin = e.target.value;
      errorMessage.style.display = 'none'; // Limpa a mensagem de erro ao trocar de ano
    });
    exportButton.addEventListener('click', exportarDados);
    document.getElementById('logout-button').addEventListener('click', () => {
      auth.signOut().then(() => window.location.href = 'login.html');
    });

    // Prote√ß√£o da rota ADM
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        db.collection('users').doc(currentUser.uid).get().then(doc => {
          if (doc.exists) {
            const userData = doc.data();
            if (userData.adm === true) {
              userInfoDisplay.textContent = `Logado como: ${userData.name || currentUser.email} (ADM)`;
              popularListaAnosAdmin();
            } else {
              alert("Acesso negado. Voc√™ n√£o tem permiss√µes de administrador.");
              window.location.href = 'index.html'; // Redireciona se n√£o for ADM
            }
          } else {
            alert("Acesso negado. Dados de usu√°rio n√£o encontrados.");
            window.location.href = 'index.html'; // Redireciona se n√£o encontrar dados
          }
        }).catch(error => {
          console.error("Erro ao verificar permiss√µes de ADM:", error);
          alert("Erro ao verificar permiss√µes. Redirecionando.");
          window.location.href = 'index.html';
        });
      } else {
        // Se n√£o houver usu√°rio logado, redireciona para o login
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>