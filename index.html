<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle Financeiro</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg-dark: #151728;
      --bg-dark-light: #1f2238;
      --accent: #ffc107;
      --accent-2: #33c27f;
      --accent-3: #ff6b6b;
      --text: #f9f9ff;
      --subtle: #747b9a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f0f2f5;
      color: #1d1d2e;
    }

    .sidebar {
      width: 280px;
      background: var(--bg-dark);
      color: var(--text);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .sidebar h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.05em;
      text-align: center;
    }

    .ano-select {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ano-select label {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--subtle);
    }

    .ano-row {
      display: flex;
      gap: 10px;
    }

    select {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: var(--bg-dark-light);
      color: var(--text);
    }

    .btn-icon {
      width: 42px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #1d1d2e;
      font-size: 22px;
      cursor: pointer;
    }

    .btn-icon:hover { opacity: 0.9; }

    .months {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }

    .month {
      padding: 12px 14px;
      border-radius: 10px;
      background: var(--bg-dark-light);
      color: var(--text);
      cursor: pointer;
      transition: transform 0.15s ease, background 0.2s ease;
    }

    .month:hover {
      transform: translateX(4px);
      background: #2b2f4a;
    }

    .month.active {
      background: var(--accent);
      color: #1d1d2e;
      font-weight: 600;
    }

    .content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header h2 {
      margin: 0;
      font-size: 26px;
    }

    .resumo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card small {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.1em;
      color: #6c7190;
    }

    .card strong {
      font-size: 26px;
    }

    .card.green strong { color: var(--accent-2); }
    .card.red strong { color: var(--accent-3); }
    .card.yellow strong { color: var(--accent); }

    .section {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section h3 {
      margin: 0;
      font-size: 20px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .form-row input,
    .form-row select {
      flex: 1;
      min-width: 160px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d5d8e6;
      background: #f9f9ff;
    }

    .form-row button {
      flex-basis: 140px;
      border: none;
      border-radius: 10px;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .form-row button:hover { opacity: 0.9; }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eef0fa;
    }

    th {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #8a8fa9;
    }

    tbody tr:hover {
      background: #f5f6ff;
    }

    .btn-inline {
      border: none;
      background: none;
      color: var(--accent-3);
      cursor: pointer;
      font-weight: 600;
    }

    .info-text {
      font-size: 13px;
      color: #6c7190;
    }

    @media (max-width: 960px) {
      body { flex-direction: column; }
      .sidebar { flex-direction: row; flex-wrap: wrap; height: auto; }
      .months { max-height: 180px; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>Controle</h1>

    <div class="ano-select">
      <label for="selectAno">Ano</label>
      <select id="selectAno"></select>
    </div>

    <div class="ano-select">
      <label>Meses</label>
      <div class="months" id="listaMeses"></div>
    </div>
  </aside>

  <main class="content">
    <div class="header">
      <h2 id="tituloMes">Selecione um ano e um mês</h2>
      <div class="resumo">
        <div class="card yellow">
          <small>Total contas (inclui cartão)</small>
          <strong id="totalContas">R$ 0,00</strong>
          <span class="info-text">Contas manuais: <span id="totalContasSemCartao">R$ 0,00</span></span>
          <span class="info-text">Cartão embutido: <span id="totalCartaoResumo">R$ 0,00</span></span>
        </div>
        <div class="card green">
          <small>Total adicionais</small>
          <strong id="totalAdicionais">R$ 0,00</strong>
        </div>
        <div class="card red">
          <small>Saldo disponível</small>
          <strong id="saldoFinal">R$ 0,00</strong>
        </div>
      </div>
    </div>

    <section class="section">
      <h3>Contas do mês</h3>
      <div class="info-text">
        O valor total do cartão de crédito é somado automaticamente às contas.
        Total do cartão: <strong id="infoCartaoNasContas">R$ 0,00</strong>
      </div>
      <div class="form-row">
        <input id="contaNome" placeholder="Descrição" />
        <input id="contaValor" type="number" placeholder="Valor em R$" />
        <select id="contaStatus">
          <option value="pendente">Pendente</option>
          <option value="pago">Pago</option>
        </select>
        <button onclick="adicionarConta()">Adicionar conta</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Conta</th>
            <th>Valor</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tabelaContas"></tbody>
      </table>
    </section>

    <section class="section">
      <h3>Adicionais (salário, vale, extras)</h3>
      <div class="form-row">
        <input id="adicionalNome" placeholder="Descrição" />
        <input id="adicionalValor" type="number" placeholder="Valor em R$" />
        <button onclick="adicionarAdicional()">Adicionar adicional</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Descrição</th>
            <th>Valor</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tabelaAdicionais"></tbody>
      </table>
    </section>

    <section class="section">
      <h3>Cartão de crédito</h3>
      <div class="form-row">
        <input id="cartaoNome" placeholder="Descrição (ex: Óculos)" />
        <input id="cartaoValor" type="number" placeholder="Valor da parcela" />
        <input id="cartaoParcelas" type="text" placeholder="Parcelas (ex: 7/10)" />
        <button onclick="adicionarCartao()">Adicionar cartão</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Descrição</th>
            <th>Valor</th>
            <th>Parcelas</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tabelaCartao"></tbody>
      </table>
    </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVwUVoudM_IxWQgkLxlabinw4AXGgf1So",
      authDomain: "controle-f1437.firebaseapp.com",
      databaseURL: "https://controle-f1437-default-rtdb.firebaseio.com",
      projectId: "controle-f1437",
      storageBucket: "controle-f1437.firebasestorage.app",
      messagingSenderId: "796244202232",
      appId: "1:796244202232:web:4e98f9b9a3c34bd569e10d"
};


    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MESES = [
      "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];
    const ANO_BASE = 2025;
    const ANO_LIMITE = ANO_BASE + 10;

    const moeda = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });
    const formatar = valor => moeda.format(Number(valor) || 0);

    let anoAtual = "";
    let mesAtual = "";
    let unsubscribeMes = null;

    const selectAno = document.getElementById("selectAno");
    const listaMeses = document.getElementById("listaMeses");

    function popularListaAnos() {
      selectAno.innerHTML = "";
      for (let ano = ANO_BASE; ano <= ANO_LIMITE; ano++) {
        const option = document.createElement("option");
        option.value = String(ano);
        option.textContent = String(ano);
        selectAno.appendChild(option);
      }
    }

    async function prepararEstruturaInicial() {
      for (let ano = ANO_BASE; ano <= ANO_LIMITE; ano++) {
        try {
          await garantirAno(ano);
        } catch (erro) {
          console.error("Falha ao criar ano inicial", ano, erro);
          throw erro;
        }
      }
    }

    async function inicializar() {
      anoAtual = String(ANO_BASE);
      popularListaAnos();
      selectAno.value = anoAtual;
      try {
        await prepararEstruturaInicial();
      } catch (erro) {
        alert("Não foi possível conectar ao Firebase. Verifique a configuração das regras e recarregue a página.");
      }
      renderizarMeses();
      await selecionarMes(MESES[0]);
      selectAno.addEventListener("change", trocarAno);
    }

    async function garantirAno(ano) {
      if (!/^[0-9]{4}$/.test(String(ano))) {
        alert("Informe um ano válido com quatro dígitos.");
        return;
      }
      const refAno = db.ref(`anos/${ano}`);
      const snap = await refAno.once("value");
      if (!snap.exists()) {
        const meses = {};
        MESES.forEach(nome => {
          meses[nome] = { contas: [], adicionais: [], cartao: [] };
        });
        await refAno.set({ ano: Number(ano), meses });
      } else {
        const data = snap.val();
        const atualizacoes = {};
        MESES.forEach(nome => {
          if (!(data.meses && data.meses[nome])) {
            atualizacoes[`meses/${nome}`] = { contas: [], adicionais: [], cartao: [] };
          }
        });
        if (Object.keys(atualizacoes).length) {
          await refAno.update(atualizacoes);
        }
      }
    }

    function renderizarMeses() {
      listaMeses.innerHTML = "";
      MESES.forEach(mes => {
        const div = document.createElement("div");
        div.className = `month ${mesAtual === mes ? "active" : ""}`;
        div.textContent = mes;
        div.onclick = () => selecionarMes(mes);
        listaMeses.appendChild(div);
      });
    }

    async function trocarAno() {
      anoAtual = selectAno.value;
      mesAtual = "";
      if (unsubscribeMes) unsubscribeMes();
      try {
        await garantirAno(anoAtual);
      } catch (erro) {
        alert("Erro ao acessar o ano selecionado. Verifique o Firebase.");
        console.error(erro);
        return;
      }
      await selecionarMes(MESES[0]);
    }

    async function selecionarMes(mes) {
      if (!anoAtual) return;
      mesAtual = mes;
      document.getElementById("tituloMes").innerText = `${mesAtual} / ${anoAtual}`;
      renderizarMeses();
      try {
        await garantirAno(anoAtual);
        escutarMes(anoAtual, mesAtual);
      } catch (erro) {
        console.error("Erro ao carregar mês", erro);
        alert("Não foi possível carregar os dados do mês no Firebase.");
      }
    }

    function escutarMes(ano, mes) {
      if (unsubscribeMes) unsubscribeMes();
      const ref = db.ref(`anos/${ano}/meses/${mes}`);
      const handler = snapshot => {
        if (!snapshot.exists()) {
          ref.set({ contas: [], adicionais: [], cartao: [] });
          return;
        }
        renderizarDadosDoMes(snapshot.val());
      };
      ref.on("value", handler, error => {
        console.error("Erro no listener do mês", error);
        alert("Não foi possível ouvir atualizações do mês. Verifique sua conexão.");
      });
      unsubscribeMes = () => ref.off("value", handler);
    }

    function limparTabelas() {
      document.getElementById("tabelaContas").innerHTML = "";
      document.getElementById("tabelaAdicionais").innerHTML = "";
      document.getElementById("tabelaCartao").innerHTML = "";
    }

    function renderizarDadosDoMes(data) {
      if (!data) {
        data = { contas: [], adicionais: [], cartao: [] };
      }
      data.contas = data.contas || [];
      data.adicionais = data.adicionais || [];
      data.cartao = data.cartao || [];
      const tabelaContas = document.getElementById("tabelaContas");
      tabelaContas.innerHTML = "";
      data.contas.forEach((conta, index) => {
        tabelaContas.innerHTML += `
          <tr>
            <td>${conta.nome}</td>
            <td>${formatar(conta.valor)}</td>
            <td>
              <select onchange="atualizarStatusConta(${index}, this.value)">
                <option value="pendente" ${conta.status === "pendente" ? "selected" : ""}>Pendente</option>
                <option value="pago" ${conta.status === "pago" ? "selected" : ""}>Pago</option>
              </select>
            </td>
            <td><button class="btn-inline" onclick="removerItem('contas', ${index})">Excluir</button></td>
          </tr>
        `;
      });

      const tabelaAdicionais = document.getElementById("tabelaAdicionais");
      tabelaAdicionais.innerHTML = "";
      data.adicionais.forEach((item, index) => {
        tabelaAdicionais.innerHTML += `
          <tr>
            <td>${item.nome}</td>
            <td>${formatar(item.valor)}</td>
            <td><button class="btn-inline" onclick="removerItem('adicionais', ${index})">Excluir</button></td>
          </tr>
        `;
      });

      const tabelaCartao = document.getElementById("tabelaCartao");
      tabelaCartao.innerHTML = "";
      data.cartao.forEach((item, index) => {
        tabelaCartao.innerHTML += `
          <tr>
            <td>${item.nome}</td>
            <td>${formatar(item.valor)}</td>
            <td>${item.parcelas || "-"}</td>
            <td><button class="btn-inline" onclick="removerItem('cartao', ${index})">Excluir</button></td>
          </tr>
        `;
      });

      atualizarResumo(data);
    }

    function getMesRef() {
      if (!anoAtual || !mesAtual) {
        alert("Escolha um ano e um mês.");
        return null;
      }
      return db.ref(`anos/${anoAtual}/meses/${mesAtual}`);
    }

    async function carregarDadosRef(ref) {
      const snap = await ref.once("value");
      return snap.val() || { contas: [], adicionais: [], cartao: [] };
    }

    async function adicionarConta() {
      const ref = getMesRef();
      if (!ref) return;
      const nome = document.getElementById("contaNome").value.trim();
      const valor = Number(document.getElementById("contaValor").value);
      const status = document.getElementById("contaStatus").value;
      if (!nome || !valor) return alert("Preencha descrição e valor.");
      const dados = await carregarDadosRef(ref);
      dados.contas = dados.contas || [];
      dados.contas.push({ nome, valor, status });
      await ref.update({ contas: dados.contas });
      document.getElementById("contaNome").value = "";
      document.getElementById("contaValor").value = "";
    }

    async function adicionarAdicional() {
      const ref = getMesRef();
      if (!ref) return;
      const nome = document.getElementById("adicionalNome").value.trim();
      const valor = Number(document.getElementById("adicionalValor").value);
      if (!nome || !valor) return alert("Preencha descrição e valor.");
      const dados = await carregarDadosRef(ref);
      dados.adicionais = dados.adicionais || [];
      dados.adicionais.push({ nome, valor });
      await ref.update({ adicionais: dados.adicionais });
      document.getElementById("adicionalNome").value = "";
      document.getElementById("adicionalValor").value = "";
    }

    async function adicionarCartao() {
      const ref = getMesRef();
      if (!ref) return;
      const nome = document.getElementById("cartaoNome").value.trim();
      const valor = Number(document.getElementById("cartaoValor").value);
      const parcelas = document.getElementById("cartaoParcelas").value.trim();
      if (!nome || !valor) return alert("Preencha descrição e valor.");
      const dados = await carregarDadosRef(ref);
      dados.cartao = dados.cartao || [];
      dados.cartao.push({ nome, valor, parcelas });
      await ref.update({ cartao: dados.cartao });
      document.getElementById("cartaoNome").value = "";
      document.getElementById("cartaoValor").value = "";
      document.getElementById("cartaoParcelas").value = "";
    }

    async function removerItem(tipo, indice) {
      const ref = getMesRef();
      if (!ref) return;
      const dados = await carregarDadosRef(ref);
      if (!dados[tipo]) return;
      dados[tipo].splice(indice, 1);
      await ref.update({ [tipo]: dados[tipo] });
    }

    async function atualizarStatusConta(indice, status) {
      const ref = getMesRef();
      if (!ref) return;
      const dados = await carregarDadosRef(ref);
      if (!dados.contas || !dados.contas[indice]) return;
      dados.contas[indice].status = status;
      await ref.update({ contas: dados.contas });
    }

    function atualizarResumo(data) {
      let totalContasManuais = 0;
      let totalAdicionais = 0;
      let totalCartao = 0;

      if (data) {
        totalContasManuais = data.contas.reduce((acc, item) => acc + Number(item.valor || 0), 0);
        totalAdicionais = data.adicionais.reduce((acc, item) => acc + Number(item.valor || 0), 0);
        totalCartao = data.cartao.reduce((acc, item) => acc + Number(item.valor || 0), 0);
      }

      const totalContas = totalContasManuais + totalCartao;
      const saldo = totalAdicionais - totalContas;

      document.getElementById("totalContas").innerText = formatar(totalContas);
      document.getElementById("totalContasSemCartao").innerText = formatar(totalContasManuais);
      document.getElementById("totalCartaoResumo").innerText = formatar(totalCartao);
      document.getElementById("totalAdicionais").innerText = formatar(totalAdicionais);
      document.getElementById("saldoFinal").innerText = formatar(saldo);
      document.getElementById("infoCartaoNasContas").innerText = formatar(totalCartao);
    }

    inicializar();
  </script>
</body>
</html>
