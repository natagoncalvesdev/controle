<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle Financeiro</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --bg-dark: #151728;
      --bg-dark-light: #1f2238;
      --accent: #ffc107;
      --accent-2: #33c27f;
      --accent-3: #ff6b6b;
      --text: #f9f9ff;
      --subtle: #747b9a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f0f2f5;
      color: #1d1d2e;
    }

    .sidebar {
      width: 280px;
      background: var(--bg-dark);
      color: var(--text);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .sidebar h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.05em;
      text-align: center;
    }

    .ano-select {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ano-select label {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--subtle);
    }

    .ano-row {
      display: flex;
      gap: 10px;
    }

    select {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: var(--bg-dark-light);
      color: var(--text);
    }

    .btn-icon {
      width: 42px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #1d1d2e;
      font-size: 22px;
      cursor: pointer;
    }

    .btn-icon:hover { opacity: 0.9; }

    .months {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }

    .month {
      padding: 12px 14px;
      border-radius: 10px;
      background: var(--bg-dark-light);
      color: var(--text);
      cursor: pointer;
      transition: transform 0.15s ease, background 0.2s ease;
    }

    .month:hover {
      transform: translateX(4px);
      background: #2b2f4a;
    }

    .sidebar-controls {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .mes-select-mobile {
      display: none; /* Oculto por padr√£o */
    }

    .month.active {
      background: var(--accent);
      color: #1d1d2e;
      font-weight: 600;
    }

    .content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header h2 {
      margin: 0;
      font-size: 26px;
    }

    .resumo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card small {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.1em;
      color: #6c7190;
    }

    .card strong {
      font-size: 26px;
    }

    .card .toggle-icon {
      display: inline-block;
      margin-left: 8px;
      font-size: 12px;
      transition: transform 0.3s ease;
    }
    .card.expanded .toggle-icon { transform: rotate(180deg); }

    .card.green strong { color: var(--accent-2); }
    .card.red strong { color: var(--accent-3); }
    .card.yellow strong { color: var(--accent); }
    .card.blue strong { color: #007bff; } /* Cor para o total reservado */

    .section {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section h3 {
      margin: 0;
      font-size: 20px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .form-row input,
    .form-row select {
      flex: 1;
      min-width: 160px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d5d8e6;
      background: #f9f9ff;
    }

    .form-row button {
      flex-basis: 140px;
      border: none;
      border-radius: 10px;
      background: #2563eb;
      color: #fff;
      padding: 12px; /* Aumenta a altura (deixa mais "gordo") */
      font-weight: 600;
      cursor: pointer;
    }
    .form-row .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      /* Permite que os bot√µes fiquem ao lado dos inputs */
      min-width: fit-content;
    }

    .recorrente-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 10px;
      background-color: var(--accent);
      color: #1d1d2e;
      font-weight: 600;
      cursor: pointer;
      user-select: none; /* Impede a sele√ß√£o de texto */
      justify-content: center;
    }
    .recorrente-toggle input[type="checkbox"] {
      display: none; /* Oculta o checkbox padr√£o */
    }
    .checkbox-box {
      width: 18px;
      height: 18px;
      background: rgba(29, 29, 46, 0.1);
      border: 1px solid rgba(29, 29, 46, 0.3);
      border-radius: 4px;
      position: relative;
    }
    .recorrente-toggle input:checked + .checkbox-box {
      background: #1d1d2e;
      border-color: #1d1d2e;
    }
    .recorrente-toggle input:checked + .checkbox-box::after {
      content: '‚úî';
      color: var(--accent);
      font-size: 14px;
      position: absolute;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
    }
    .form-row button:hover { opacity: 0.9; }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      vertical-align: middle; /* Garante alinhamento vertical consistente */
      border-bottom: 1px solid #eef0fa;
    }

    th {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #8a8fa9;
    }

    tbody tr:hover {
      background: #f5f6ff;
    }

    .btn-inline {
      border: none;
      background: none;
      color: var(--accent-3);
      cursor: pointer;
      font-weight: 600;
    }

    table select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d5d8e6;
      background: #fff;
      color: #1d1d2e;
    }

    .status-tag {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
    }

    .status-pendente {
      background: rgba(255, 107, 107, 0.2);
      color: #ba2f2f;
    }

    .status-pago {
      background: rgba(51, 194, 127, 0.2);
      color: #1e8558;
    }

    .row-pendente {
      background: rgba(255, 107, 107, 0.1);
    }

    .row-pago {
      background: rgba(51, 194, 127, 0.1);
    }

    .info-text {
      font-size: 13px;
      color: #6c7190;
    }

    .actions-cell {
      display: flex;
      gap: 10px;
      align-items: center; /* Alinha os bot√µes verticalmente */
    }

    .btn-icon-inline {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
    }
    .btn-icon-inline.edit {
      color: var(--subtle);
    }
    .btn-icon-inline.edit:hover {
      color: var(--accent-2);
    }
    .btn-icon-inline.copy {
      color: var(--subtle);
    }
    .btn-icon-inline.copy:hover {
      color: #2563eb;
    }

    td input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #aab1d3;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    /* Estilos da Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none; /* Oculto por padr√£o */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .modal-content h3 {
      margin: 0;
      font-size: 18px;
    }
    .modal-month-list {
      max-height: 250px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-top: 1px solid #eef0fa;
      border-bottom: 1px solid #eef0fa;
      padding: 12px 0;
    }
    .modal-month-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .modal-month-item label {
      flex: 1;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .modal-actions button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .modal-actions .btn-confirm { background: #2563eb; color: #fff; }
    .modal-actions .btn-cancel { background: #eef0fa; color: #6c7190; }
    .modal-overlay.visible {
      display: flex;
    }
    
    .collapsible-section, .hidden-section {
      display: none; /* Escondido por padr√£o */
      margin-top: -8px; /* Reduz o espa√ßo quando expandido */
      border-top-left-radius: 0; border-top-right-radius: 0;
    }

    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: column;
        padding: 16px;
      }
      .sidebar-controls {
        flex-direction: row;
        gap: 16px;
        align-items: flex-end;
      }
      .sidebar-controls .ano-select, .sidebar-controls .mes-select-mobile {
        flex: 1;
      }
      .mes-select-mobile {
        display: flex; /* Exibido em mobile */
        flex-direction: column;
        gap: 12px;
      }
      .mes-select-mobile label {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--subtle);
      }
      .months-wrapper { 
        display: none; /* Oculta a lista de meses em mobile */
      }
      .content { padding: 16px; }
      .header h2 { font-size: 22px; }
      .card strong { font-size: 22px; }

      .form-row {
        flex-direction: column;
        align-items: stretch;
      }
      .form-row button {
        padding: 10px 12px;
      }
      th, td {
        padding: 10px 8px;
      }
      /* Remove a altura m√≠nima que causava problemas de alinhamento */
      .actions-cell { min-height: unset; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>Controle</h1>

    <div class="sidebar-controls">
      <div class="ano-select">
        <label for="selectAno">Ano</label>
        <select id="selectAno"></select>
      </div>
      <div class="mes-select-mobile">
        <label for="selectMesMobile">M√™s</label>
        <select id="selectMesMobile"></select>
      </div>
    </div>

    <div class="months-wrapper">
      <label>Meses</label>
      <div class="months" id="listaMeses"></div>
    </div>
  </aside>

  <main class="content">
    <div class="header">
      <h2 id="tituloMes">Selecione um ano e um m√™s</h2>
      <div class="resumo">
        <div class="card yellow">
          <small>Total contas (inclui cart√£o)</small>
          <strong id="totalContas">R$¬†0,00</strong>
          <span class="info-text">Contas manuais: <span id="totalContasSemCartao">R$¬†0,00</span></span>
          <span class="info-text">Cart√£o embutido: <span id="totalCartaoResumo">R$¬†0,00</span></span>
        </div>
        <div class="card green">
          <small style="cursor: pointer;" onclick="abrirModalEntradas()">Total entradas</small>
          <strong id="totalAdicionais">R$¬†0,00</strong>
        </div>
        <div class="card red">
          <small>Saldo dispon√≠vel</small>
          <strong id="saldoFinal">R$¬†0,00</strong>
        </div>
        <div class="card blue">
          <small>Total reservado</small>
          <strong id="totalReservado">R$¬†0,00</strong>
        </div>
      </div>
    </div>

    <section class="section">
      <h3>Contas do m√™s</h3>
      <div class="info-text">
        O valor total do cart√£o de cr√©dito √© somado automaticamente √†s contas.
        Total do cart√£o: <strong id="infoCartaoNasContas">R$¬†0,00</strong>
      </div>
      <div class="form-row">
        <input id="contaNome" placeholder="Descri√ß√£o" />
        <input id="contaValor" type="number" placeholder="Valor em R$" />
        <select id="contaStatus">
          <option value="pendente">Pendente</option>
          <option value="pago">Pago</option>
        </select>
        <div class="form-actions">
          <button onclick="adicionarConta()">Adicionar conta</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
        <thead>
          <tr>
            <th>Conta</th>
            <th>Valor</th>
            <th>Status</th>
            <th>Mudar Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tabelaContas"></tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h3>Cart√£o de cr√©dito</h3>
      <div class="form-row">
        <input id="cartaoNome" placeholder="Descri√ß√£o (ex: √ìculos)" />
        <input id="cartaoValor" type="number" placeholder="Valor da parcela" />
        <input id="cartaoTotalParcelas" type="number" placeholder="Total de Parcelas (ex: 10)" />
        <div class="form-actions">
          <button onclick="adicionarCartao()">Adicionar compra</button>
          <button onclick="abrirModalAdiantar()">Adiantar Parcela</button>
          <label class="recorrente-toggle">
            <input type="checkbox" id="cartaoRecorrente"><span class="checkbox-box"></span><span>Recorrente</span>
          </label>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
        <thead>
          <tr>
            <th>Descri√ß√£o</th>
            <th>Valor</th>
            <th>Parcelas</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaCartao"></tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h3>Reservados (combust√≠vel, lazer, etc.)</h3>
      <div class="form-row">
        <input id="reservadoNome" placeholder="Descri√ß√£o" />
        <input id="reservadoValor" type="number" placeholder="Valor em R$" />
        <div class="form-actions">
          <button onclick="adicionarReservado()">Adicionar reservado</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
        <thead>
          <tr>
            <th>Descri√ß√£o</th>
            <th>Valor</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaReservado"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Modal para Copiar Itens -->
  <div id="copyModal" class="modal-overlay">
    <div class="modal-content">
      <h3>Copiar item para outros meses</h3>
      <div id="copyMonthList" class="modal-month-list">
        <!-- A lista de meses ser√° populada via JS -->
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="fecharModalCopia()">Cancelar</button>
        <button class="btn-confirm" onclick="confirmarCopia()">Concluir</button>
      </div>
    </div>
  </div>

  <!-- Modal para Entradas -->
  <div id="entradasModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 550px;">
      <h3>Entradas do M√™s</h3>
      <div class="form-row">
        <input id="adicionalNomeModal" placeholder="Descri√ß√£o da entrada" />
        <input id="adicionalValorModal" type="number" placeholder="Valor em R$" />
        <div class="form-actions">
          <button onclick="adicionarAdicional()">Adicionar</button>
        </div>
      </div>
      <div class="table-wrapper" style="margin-top: 16px;">
        <table>
          <thead>
            <tr>
              <th>Descri√ß√£o</th>
              <th>Valor</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaAdicionaisModal"></tbody>
        </table>
      </div>
      <div class="modal-actions"><button class="btn-cancel" onclick="fecharModalEntradas()">Fechar</button></div>
    </div>
  </div>

  <!-- Modal para Adiantar Parcelas -->
  <div id="anticipateModal" class="modal-overlay">
    <div class="modal-content">
      <h3>Adiantar parcelas para o m√™s atual</h3>
      <div id="anticipateInstallmentList" class="modal-month-list">
        <!-- A lista de parcelas ser√° populada via JS -->
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="fecharModalAdiantar()">Cancelar</button>
        <button class="btn-confirm" onclick="confirmarAdiantamento()">Concluir</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVwUVoudM_IxWQgkLxlabinw4AXGgf1So",
      authDomain: "controle-f1437.firebaseapp.com",
      databaseURL: "https://controle-f1437-default-rtdb.firebaseio.com",
      projectId: "controle-f1437",
      storageBucket: "controle-f1437.firebasestorage.app",
      messagingSenderId: "796244202232",
      appId: "1:796244202232:web:4e98f9b9a3c34bd569e10d"
};


    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const MESES = [
      "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];
    const ANO_BASE = 2025;
    const ANO_LIMITE = ANO_BASE + 10;

    const moeda = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });
    const formatar = valor => moeda.format(Number(valor) || 0);

    let anoAtual = "";
    let mesAtual = "";
    let unsubscribeMes = null;
    let itemParaCopiar = null;
    let parcelasParaAdiantar = [];

    const selectAno = document.getElementById("selectAno");
    const listaMeses = document.getElementById("listaMeses");
    const selectMesMobile = document.getElementById("selectMesMobile");

    function popularListaAnos() {
      selectAno.innerHTML = "";
      for (let ano = ANO_BASE; ano <= ANO_LIMITE; ano++) {
        const option = document.createElement("option");
        option.value = String(ano);
        option.textContent = String(ano);
        selectAno.appendChild(option);
      }
    }

    function popularSeletorMeses() {
      selectMesMobile.innerHTML = "";
      MESES.forEach(mes => {
        const option = document.createElement("option");
        option.value = mes;
        option.textContent = mes;
        selectMesMobile.appendChild(option);
      });
    }

    async function inicializar() {
      const hoje = new Date();
      let anoCorrente = hoje.getFullYear();
      const mesCorrente = MESES[hoje.getMonth()];

      popularListaAnos();
      popularSeletorMeses();

      // Garante que o ano atual esteja no seletor. Se n√£o estiver, usa o ANO_BASE.
      if (anoCorrente < ANO_BASE || anoCorrente > ANO_LIMITE) {
        anoCorrente = ANO_BASE;
      }

      anoAtual = String(anoCorrente);
      selectAno.value = anoAtual; // Define o valor no seletor

      await garantirAno(anoAtual); // Garante que a estrutura do ano exista no DB
      await selecionarMes(mesCorrente); // Seleciona o m√™s e ano atuais

      selectAno.addEventListener("change", trocarAno);
      selectMesMobile.addEventListener("change", (e) => selecionarMes(e.target.value));
    }

    async function garantirAno(ano) {
      if (!/^[0-9]{4}$/.test(String(ano))) {
        alert("Informe um ano v√°lido com quatro d√≠gitos.");
        return;
      }
      const ref = db.collection("anos").doc(String(ano));
      const doc = await ref.get();
      if (!doc.exists) {
        await ref.set({ ano: Number(ano) });
        const mesesBatch = MESES.map(nome =>
          ref.collection("meses").doc(nome).set({ contas: [], adicionais: [], cartao: [], reservado: [], cartaoStatus: 'pendente' })
        );
        await Promise.all(mesesBatch);
      } else {
        await ref.set({ ano: Number(ano) }, { merge: true });
      }
    }

    function renderizarMeses() {
      listaMeses.innerHTML = "";
      MESES.forEach(mes => {
        const div = document.createElement("div");
        div.className = `month ${mesAtual === mes ? "active" : ""}`;
        div.textContent = mes;
        div.onclick = () => selecionarMes(mes);
        listaMeses.appendChild(div);
      });
      selectMesMobile.value = mesAtual;
    }

    async function trocarAno() {
      anoAtual = selectAno.value;
      mesAtual = "";
      if (unsubscribeMes) unsubscribeMes();
      await garantirAno(anoAtual);
      await selecionarMes(MESES[0]);
    }

    async function selecionarMes(mes) {
      if (!anoAtual) return;
      mesAtual = mes;
      document.getElementById("tituloMes").innerText = `${mesAtual} / ${anoAtual}`;
      renderizarMeses();
      await garantirAno(anoAtual);
      escutarMes(anoAtual, mesAtual);
    }

    function escutarMes(ano, mes) {
      if (unsubscribeMes) unsubscribeMes();
      const ref = db.collection("anos").doc(ano).collection("meses").doc(mes);
      unsubscribeMes = ref.onSnapshot(doc => {
        if (!doc.exists) {
          ref.set({ contas: [], adicionais: [], cartao: [], reservado: [], cartaoStatus: 'pendente' });
          return;
        }
        renderizarDadosDoMes(doc.data());
      }, error => {
        console.error("Erro no listener do m√™s", error);
        alert("N√£o foi poss√≠vel ouvir atualiza√ß√µes do m√™s. Verifique sua conex√£o.");
      });
    }

    function limparTabelas() {
      document.getElementById("tabelaContas").innerHTML = "";
      document.getElementById("tabelaAdicionaisModal").innerHTML = "";
      document.getElementById("tabelaCartao").innerHTML = "";
      document.getElementById("tabelaReservado").innerHTML = "";
    }

    function renderizarDadosDoMes(data) {
      if (!data) {
        data = { contas: [], adicionais: [], cartao: [], reservado: [] };
      }
      data.contas = data.contas || [];
      data.adicionais = data.adicionais || [];
      data.cartao = data.cartao || [];
      data.reservado = data.reservado || [];
      const statusCartao = data.cartaoStatus || 'pendente';

      // Ordena as contas manualmente em ordem alfab√©tica
      const contasOrdenadas = [...data.contas].sort((a, b) => a.nome.localeCompare(b.nome));

      // Calcula o total do cart√£o para adicion√°-lo como um item na lista de contas
      const totalCartao = data.cartao.reduce((acc, item) => acc + Number(item.valor || 0), 0);
      if (totalCartao > 0) {
        contasOrdenadas.push({
          nome: "Cart√£o de Cr√©dito",
          valor: totalCartao,
          status: statusCartao,
          isCartao: true // Flag para identificar que este n√£o √© um item comum
        });
        // Reordena ap√≥s adicionar o cart√£o para garantir a posi√ß√£o correta
        contasOrdenadas.sort((a, b) => a.nome.localeCompare(b.nome));
      }

      const tabelaContas = document.getElementById("tabelaContas");
      tabelaContas.innerHTML = "";
      contasOrdenadas.forEach((conta) => {
        // Para itens que n√£o s√£o do cart√£o, encontramos o √≠ndice original para as a√ß√µes funcionarem
        const originalIndex = conta.isCartao ? -1 : data.contas.findIndex(c => c.nome === conta.nome && c.valor === conta.valor);

        const status = conta.status || "pendente";
        let rowHTML = `
          <tr class="${status === "pago" ? "row-pago" : "row-pendente"}">
            <td>${conta.nome}</td>
            <td>${formatar(conta.valor)}</td>
            <td>
              <div class="status-tag ${status === "pago" ? "status-pago" : "status-pendente"}">
                ${status === "pago" ? "Pago" : "Pendente"}
              </div>
            </td>
        `;

        if (conta.isCartao) {
          rowHTML += `
            <td>
              <select onchange="atualizarStatusCartao(this.value)">
                <option value="pendente" ${status === "pendente" ? "selected" : ""}>Pendente</option>
                <option value="pago" ${status === "pago" ? "selected" : ""}>Pago</option>
              </select>
            </td>
            <td class="actions-cell"></td>
          `;
        } else {
          rowHTML += `
            <td>
                <select onchange="atualizarStatusConta(${originalIndex}, this.value)">
                  <option value="pendente" ${status === "pendente" ? "selected" : ""}>Pendente</option>
                  <option value="pago" ${status === "pago" ? "selected" : ""}>Pago</option>
                </select>
            </td>
            <td class="actions-cell">
                <button class="btn-icon-inline edit" onclick="editarItem(this, 'contas', ${originalIndex})">‚úèÔ∏è</button>
                <button class="btn-icon-inline copy" onclick="abrirModalCopia('contas', ${originalIndex})">‚ùê</button>
                <button class="btn-inline" onclick="removerItem('contas', ${originalIndex})">üóëÔ∏è</button>
            </td>`;
        }
        rowHTML += `</tr>`;
        tabelaContas.innerHTML += rowHTML;
      });

      const tabelaAdicionais = document.getElementById("tabelaAdicionaisModal");
      tabelaAdicionais.innerHTML = "";
      (data.adicionais || []).forEach((item, index) => {
        tabelaAdicionais.innerHTML += `
          <tr>
            <td>${item.nome}</td>
            <td>${formatar(item.valor)}</td>
            <td class="actions-cell">
              <button class="btn-icon-inline edit" onclick="editarItem(this, 'adicionais', ${index})">‚úèÔ∏è</button>
              <button class="btn-icon-inline copy" onclick="abrirModalCopia('adicionais', ${index})">‚ùê</button>
              <button class="btn-inline" onclick="removerItem('adicionais', ${index})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      const tabelaCartao = document.getElementById("tabelaCartao");
      tabelaCartao.innerHTML = "";
      data.cartao.forEach((item, index) => {
        tabelaCartao.innerHTML += `
          <tr>
            <td>${item.nome}</td>
            <td>${formatar(item.valor)}</td>
            <td>${item.parcelas || "-"}</td>
            <td class="actions-cell">
              <button class="btn-icon-inline edit" onclick="editarItem(this, 'cartao', ${index})">‚úèÔ∏è</button>
              <button class="btn-inline" onclick="removerItem('cartao', ${index})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      const tabelaReservado = document.getElementById("tabelaReservado");
      tabelaReservado.innerHTML = "";
      data.reservado.forEach((item, index) => {
        tabelaReservado.innerHTML += `
          <tr>
            <td>${item.nome}</td>
            <td>${formatar(item.valor)}</td>
            <td class="actions-cell">
              <button class="btn-icon-inline edit" onclick="editarItem(this, 'reservado', ${index})">‚úèÔ∏è</button>
              <button class="btn-icon-inline copy" onclick="abrirModalCopia('reservado', ${index})">‚ùê</button>
              <button class="btn-inline" onclick="removerItem('reservado', ${index})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      atualizarResumo(data);
    }

    function getMesRef() {
      if (!anoAtual || !mesAtual) {
        alert("Escolha um ano e um m√™s.");
        return null;
      }
      return db.collection("anos").doc(anoAtual).collection("meses").doc(mesAtual);
    }

    async function carregarDadosRef(ref) {
      const doc = await ref.get();
      return doc.exists ? doc.data() : { contas: [], adicionais: [], cartao: [], reservado: [], cartaoStatus: 'pendente' };
    }

    async function adicionarConta() {
      const ref = getMesRef();
      if (!ref) return;
      const nome = document.getElementById("contaNome").value.trim();
      const valor = Number(document.getElementById("contaValor").value);
      const status = document.getElementById("contaStatus").value;
      if (!nome || !valor) return alert("Preencha descri√ß√£o e valor.");
      await ref.update({
        contas: firebase.firestore.FieldValue.arrayUnion({ nome, valor, status })
      });
      document.getElementById("contaNome").value = "";
      document.getElementById("contaValor").value = "";
    }

    async function adicionarAdicional() {
      const ref = getMesRef();
      if (!ref) return;
      const nomeInput = document.getElementById("adicionalNomeModal");
      const valorInput = document.getElementById("adicionalValorModal");
      const nome = nomeInput.value.trim();
      const valor = Number(valorInput.value);
      if (!nome || !valor) return alert("Preencha descri√ß√£o e valor.");
      await ref.update({
        adicionais: firebase.firestore.FieldValue.arrayUnion({ nome, valor })
      });
      nomeInput.value = "";
      valorInput.value = "";
    }

    async function adicionarReservado() {
      const ref = getMesRef();
      if (!ref) return;
      const nome = document.getElementById("reservadoNome").value.trim();
      const valor = Number(document.getElementById("reservadoValor").value);
      if (!nome || !valor) return alert("Preencha descri√ß√£o e valor.");
      await ref.update({
        reservado: firebase.firestore.FieldValue.arrayUnion({ nome, valor })
      });
      document.getElementById("reservadoNome").value = "";
      document.getElementById("reservadoValor").value = "";
    }

    async function adicionarCartao() {
      const ref = getMesRef();
      if (!ref) return;
      const nome = document.getElementById("cartaoNome").value.trim();
      const valor = Number(document.getElementById("cartaoValor").value);
      const isRecorrente = document.getElementById("cartaoRecorrente").checked;
      const totalParcelas = Number(document.getElementById("cartaoTotalParcelas").value) || 1;

      if (!nome || !valor) {
        return alert("Preencha descri√ß√£o e valor da compra.");
      }

      const mesAtualIndex = MESES.indexOf(mesAtual);
      const batch = db.batch();

      if (isRecorrente) {
        // L√≥gica para item recorrente
        const novaCompra = { nome, valor, parcelas: "Recorrente", recorrente: true };
        const anoFinal = ANO_LIMITE;

        for (let ano = Number(anoAtual); ano <= anoFinal; ano++) {
          await garantirAno(String(ano));
          const mesInicial = (ano === Number(anoAtual)) ? mesAtualIndex : 0;
          for (let mesIdx = mesInicial; mesIdx < 12; mesIdx++) {
            const mesNome = MESES[mesIdx];
            const parcelaRef = db.collection("anos").doc(String(ano)).collection("meses").doc(mesNome);
            batch.update(parcelaRef, { cartao: firebase.firestore.FieldValue.arrayUnion(novaCompra) });
          }
        }

      } else {
        // L√≥gica para parcelamento normal
        if (totalParcelas < 1) {
        return alert("O n√∫mero de parcelas deve ser 1 ou maior.");
        }

        for (let i = 0; i < totalParcelas; i++) {
          const targetMesIndex = (mesAtualIndex + i) % 12;
          const targetAno = Number(anoAtual) + Math.floor((mesAtualIndex + i) / 12);
          const targetMesNome = MESES[targetMesIndex];

          if (targetAno > ANO_LIMITE) continue; // N√£o adiciona al√©m do ano limite

          // Garante que o ano e a estrutura de meses existam antes de adicionar
          await garantirAno(String(targetAno));

          const parcelaRef = db.collection("anos").doc(String(targetAno)).collection("meses").doc(targetMesNome);
          const novaCompra = {
            nome,
            valor,
            parcelas: `${i + 1}/${totalParcelas}`
          };
          batch.update(parcelaRef, { cartao: firebase.firestore.FieldValue.arrayUnion(novaCompra) });
        }
      }

      await batch.commit();

      document.getElementById("cartaoNome").value = "";
      document.getElementById("cartaoValor").value = "";
      document.getElementById("cartaoTotalParcelas").value = "";
      document.getElementById("cartaoRecorrente").checked = false;
    }

    async function removerItem(tipo, indice) {      
      const ref = getMesRef();
      if (!ref) return;
      const dados = await carregarDadosRef(ref);
      const item = dados[tipo][indice];

      if (!item) return;

      // L√≥gica especial para remover itens recorrentes do cart√£o
      if (tipo === 'cartao' && item.recorrente) {
        if (!confirm("Esta √© uma compra recorrente. Deseja excluir esta e TODAS as ocorr√™ncias futuras?")) {
          return;
        }

        const batch = db.batch();
        const mesAtualIndex = MESES.indexOf(mesAtual);

        for (let ano = Number(anoAtual); ano <= ANO_LIMITE; ano++) {
          const mesInicial = (ano === Number(anoAtual)) ? mesAtualIndex : 0;
          for (let mesIdx = mesInicial; mesIdx < 12; mesIdx++) {
            const mesNome = MESES[mesIdx];
            const futureRef = db.collection("anos").doc(String(ano)).collection("meses").doc(mesNome);
            // arrayRemove precisa do objeto exato para funcionar
            batch.update(futureRef, { cartao: firebase.firestore.FieldValue.arrayRemove(item) });
          }
        }

        await batch.commit();
        alert("Compra recorrente removida de todos os meses futuros.");
        return; // Finaliza a fun√ß√£o aqui
      }

      // L√≥gica padr√£o para remover um √∫nico item
      dados[tipo].splice(indice, 1);
      await ref.set(dados);
    }

    async function atualizarStatusConta(indice, status) {
      const ref = getMesRef();
      if (!ref) return;
      const doc = await ref.get();
      if (!doc.exists) return;
      const dados = doc.data();
      dados.contas[indice].status = status;
      await ref.update({ contas: dados.contas });
    }

    async function atualizarStatusCartao(status) {
      const ref = getMesRef();
      if (!ref) return;
      await ref.update({ cartaoStatus: status });
    }

    async function editarItem(button, tipo, indice) {
      const tr = button.closest('tr');
      if (tr.classList.contains('editing')) return; // J√° est√° em modo de edi√ß√£o

      const ref = getMesRef();
      if (!ref) return;
      const dados = await carregarDadosRef(ref);
      const item = dados[tipo][indice];
      if (!item) return;

      if (tipo === 'cartao' && ((item.parcelas && item.parcelas.includes('/')) || item.recorrente)) {
        alert("N√£o √© poss√≠vel editar um item parcelado ou recorrente. Por favor, remova a compra e adicione novamente se necess√°rio.");
        return;
      }

      tr.classList.add('editing');

      const nomeTd = tr.children[0];
      const valorTd = tr.children[1];

      nomeTd.innerHTML = `<input type="text" value="${item.nome}" />`;
      valorTd.innerHTML = `<input type="number" step="0.01" value="${item.valor}" />`;

      button.textContent = '‚úîÔ∏è';
      button.onclick = () => salvarEdicao(button, tipo, indice);
    }

    async function salvarEdicao(button, tipo, indice) {
      const tr = button.closest('tr');
      const nomeInput = tr.querySelector('td:nth-child(1) input');
      const valorInput = tr.querySelector('td:nth-child(2) input');

      const novoNome = nomeInput.value.trim();
      const novoValor = Number(valorInput.value);

      if (!novoNome || isNaN(novoValor)) {
        return alert("Descri√ß√£o e valor s√£o obrigat√≥rios e o valor deve ser um n√∫mero.");
      }

      const ref = getMesRef();
      if (!ref) return;
      const dados = await carregarDadosRef(ref);
      const item = dados[tipo][indice];

      dados[tipo][indice] = {
        ...item,
        nome: novoNome,
        valor: novoValor
      };

      await ref.update({ [tipo]: dados[tipo] });
      // O listener onSnapshot ir√° re-renderizar a linha, removendo a classe 'editing' e os inputs.
    }

    async function abrirModalCopia(tipo, indice) {
      const ref = getMesRef();
      if (!ref) return;
      const dados = await carregarDadosRef(ref);
      const item = dados[tipo][indice];

      if (!item) return;

      itemParaCopiar = { tipo, item };

      const lista = document.getElementById('copyMonthList');
      lista.innerHTML = '';
      const mesAtualIndex = MESES.indexOf(mesAtual);

      for (let i = 1; i <= 12; i++) {
        const targetMesIndex = (mesAtualIndex + i) % 12;
        const targetAno = Number(anoAtual) + Math.floor((mesAtualIndex + i) / 12);
        const targetMesNome = MESES[targetMesIndex];

        const id = `check-${targetAno}-${targetMesNome}`;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'modal-month-item';
        itemDiv.innerHTML = `
          <input type="checkbox" id="${id}" data-ano="${targetAno}" data-mes="${targetMesNome}">
          <label for="${id}">${targetMesNome} / ${targetAno}</label>
        `;
        lista.appendChild(itemDiv);
      }

      document.getElementById('copyModal').classList.add('visible');
    }

    function fecharModalCopia() {
      document.getElementById('copyModal').classList.remove('visible');
      itemParaCopiar = null;
    }

    async function confirmarCopia() {
      if (!itemParaCopiar) return;

      const checkboxes = document.querySelectorAll('#copyMonthList input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        return alert("Selecione pelo menos um m√™s.");
      }

      const batch = db.batch();
      const { tipo, item } = itemParaCopiar;

      // Para contas, o status padr√£o ao copiar √© 'pendente'
      const itemCopiado = (tipo === 'contas') ? { ...item, status: 'pendente' } : { ...item };

      for (const check of checkboxes) {
        const ano = check.dataset.ano;
        const mes = check.dataset.mes;

        await garantirAno(ano);
        const ref = db.collection("anos").doc(ano).collection("meses").doc(mes);
        batch.update(ref, {
          [tipo]: firebase.firestore.FieldValue.arrayUnion(itemCopiado)
        });
      }

      await batch.commit();
      alert(`${checkboxes.length} c√≥pia(s) realizada(s) com sucesso!`);
      fecharModalCopia();
    }

    async function abrirModalAdiantar() {
      // Verifica se o m√™s selecionado √© um m√™s passado
      const hoje = new Date();
      const anoCorrenteReal = hoje.getFullYear();
      const mesCorrenteRealIndex = hoje.getMonth();

      const anoSelecionado = Number(anoAtual);
      const mesSelecionadoIndex = MESES.indexOf(mesAtual);

      const isMesPassado = anoSelecionado < anoCorrenteReal || 
                           (anoSelecionado === anoCorrenteReal && mesSelecionadoIndex < mesCorrenteRealIndex);

      if (isMesPassado) {
        return alert("N√£o √© poss√≠vel adiantar parcelas para um m√™s que j√° passou.");
      }

      const lista = document.getElementById('anticipateInstallmentList');
      lista.innerHTML = 'Buscando parcelas futuras...';
      document.getElementById('anticipateModal').classList.add('visible');

      parcelasParaAdiantar = [];
      const mesAtualIndex = MESES.indexOf(mesAtual);
      let parcelasEncontradas = [];

      // Busca por parcelas nos pr√≥ximos 24 meses
      for (let i = 1; i <= 24; i++) {
        const targetMesIndex = (mesAtualIndex + i) % 12;
        const targetAno = Number(anoAtual) + Math.floor((mesAtualIndex + i) / 12);
        const targetMesNome = MESES[targetMesIndex];

        const ref = db.collection("anos").doc(String(targetAno)).collection("meses").doc(targetMesNome);
        const doc = await ref.get();

        if (doc.exists && doc.data().cartao && doc.data().cartao.length > 0) {
          doc.data().cartao.forEach((item, index) => {
            // Adiciona apenas itens parcelados e n√£o recorrentes
            if (item.parcelas && item.parcelas.includes('/') && item.parcelas !== '1/1' && !item.recorrente) {
              parcelasEncontradas.push({
                ...item,
                source: { ano: String(targetAno), mes: targetMesNome, index: index }
              });
            }
          });
        }
      }

      lista.innerHTML = '';
      if (parcelasEncontradas.length === 0) {
        lista.innerHTML = 'Nenhuma parcela futura encontrada.';
      } else {
        parcelasParaAdiantar = parcelasEncontradas;
        const comprasAgrupadas = parcelasEncontradas.reduce((acc, item, index) => {
          if (!acc[item.nome]) {
            acc[item.nome] = { valor: item.valor, parcelas: [] };
          }
          acc[item.nome].parcelas.push({ ...item, originalIndex: index });
          return acc;
        }, {});

        Object.keys(comprasAgrupadas).forEach(nomeCompra => {
          const compra = comprasAgrupadas[nomeCompra];
          const totalAdiantamento = compra.parcelas.length * compra.valor;
          const idCompra = `compra-group-${nomeCompra.replace(/\s+/g, '-')}`;

          const compraDiv = document.createElement('div');
          compraDiv.style.marginBottom = '15px';
          compraDiv.innerHTML = `
            <div class="modal-month-item" style="background: #f5f6ff; padding: 8px; border-radius: 8px;">
              <input type="checkbox" id="${idCompra}" onchange="toggleParcelasGrupo('${idCompra}', this.checked)">
              <label for="${idCompra}">
                <strong>${nomeCompra}</strong>
                <small style="display: block; color: var(--subtle);">
                  Adiantar ${compra.parcelas.length} parcela(s) - Total: ${formatar(totalAdiantamento)}
                </small>
              </label>
            </div>
          `;

          compra.parcelas.forEach(item => {
            const idParcela = `anticipate-check-${item.originalIndex}`;
            const parcelaDiv = document.createElement('div');
            parcelaDiv.className = 'modal-month-item';
            parcelaDiv.style.paddingLeft = '25px';
            parcelaDiv.innerHTML = `
              <input type="checkbox" class="${idCompra}" id="${idParcela}" data-index="${item.originalIndex}">
              <label for="${idParcela}">
                Parcela ${item.parcelas} - ${formatar(item.valor)}
                <small style="display: block; color: var(--subtle);">Origem: ${item.source.mes}/${item.source.ano}</small>
              </label>
            `;
            compraDiv.appendChild(parcelaDiv);
          });
          lista.appendChild(compraDiv);
        });
      }
    }

    function fecharModalAdiantar() {
      document.getElementById('anticipateModal').classList.remove('visible');
      parcelasParaAdiantar = [];
    }

    function toggleParcelasGrupo(className, isChecked) {
      document.querySelectorAll(`input.${className}`).forEach(checkbox => {
        checkbox.checked = isChecked;
      });
    }

    function abrirModalEntradas() {
      document.getElementById('entradasModal').classList.add('visible');
    }

    function fecharModalEntradas() {
      document.getElementById('entradasModal').classList.remove('visible');
    }


    function atualizarResumo(data) {
      let totalContasManuais = 0;
      let totalAdicionais = 0;
      let totalCartao = 0;
      let totalReservado = 0;

      if (data) {
        totalContasManuais = data.contas.reduce((acc, item) => acc + Number(item.valor || 0), 0);
        totalAdicionais = data.adicionais.reduce((acc, item) => acc + Number(item.valor || 0), 0);
        totalCartao = data.cartao.reduce((acc, item) => acc + Number(item.valor || 0), 0);
        totalReservado = data.reservado.reduce((acc, item) => acc + Number(item.valor || 0), 0);
      }

      const totalContas = totalContasManuais + totalCartao;
      const saldo = totalAdicionais - totalContas - totalReservado;

      document.getElementById("totalContas").innerText = formatar(totalContas);
      document.getElementById("totalContasSemCartao").innerText = formatar(totalContasManuais);
      document.getElementById("totalCartaoResumo").innerText = formatar(totalCartao);
      document.getElementById("totalAdicionais").innerText = formatar(totalAdicionais);
      document.getElementById("totalReservado").innerText = formatar(totalReservado);
      document.getElementById("saldoFinal").innerText = formatar(saldo);
      document.getElementById("infoCartaoNasContas").innerText = formatar(totalCartao);
    }

    async function confirmarAdiantamento() {
      const checkboxes = document.querySelectorAll('#anticipateInstallmentList input[type="checkbox"]:checked:not([id^="compra-group-"])');
      if (checkboxes.length === 0) {
        return alert("Selecione pelo menos uma parcela para adiantar.");
      }

      const batch = db.batch();
      const refMesAtual = getMesRef();

      for (const check of checkboxes) {
        const index = Number(check.dataset.index);
        const parcela = parcelasParaAdiantar[index];
        if (!parcela) continue;

        const { source, ...itemOriginal } = parcela;
        const refMesOrigem = db.collection("anos").doc(source.ano).collection("meses").doc(source.mes);

        // 1. Remove do m√™s de origem
        // O objeto para remover n√£o deve conter a propriedade 'source'
        batch.update(refMesOrigem, {
          cartao: firebase.firestore.FieldValue.arrayRemove(itemOriginal)
        });

        // 2. Adiciona ao m√™s atual
        batch.update(refMesAtual, {
          cartao: firebase.firestore.FieldValue.arrayUnion(itemOriginal)
        });
      }

      await batch.commit();
      alert(`${checkboxes.length} parcela(s) adiantada(s) com sucesso!`);
      fecharModalAdiantar();
    }

    inicializar();
  </script>
</body>
</html>
 